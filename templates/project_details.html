{% extends "master.html" %}

{% block content %}
<div class="row justify-content-between align-items-center page-header mb-4">
    <div class="col-md-8">
        <h1>{{ project.name }}</h1>
        <p class="lead text-muted">{{ project.description }}</p>
    </div>
    <!-- This div now centers buttons on small screens and aligns them to the right on medium screens and up -->
    <div class="col-md-4 d-flex justify-content-center justify-content-md-end gap-2 mt-3 mt-md-0">
        {% if is_owner %}
        <a href="{{ url_for('edit_project', project_id=project.id) }}" class="btn btn-outline-primary">
            <i class="fas fa-edit"></i> Edit Project
        </a>
        <form action="{{ url_for('delete_project', project_id=project.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this project and all its tasks?');">
            <button type="submit" class="btn btn-outline-danger">
                <i class="fas fa-trash-alt"></i> Delete Project
            </button>
        </form>
        {% endif %}
    </div>
</div>

<!-- Project status and member management -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <h4 class="mb-3">Project Status</h4>
        <span class="badge fs-6 
            {% if project.status == 'Completed' %}bg-success{% elif project.status == 'Archived' %}bg-secondary{% else %}bg-primary{% endif %}">
            {{ project.status }}
        </span>
        {% if is_owner %}
        <form action="{{ url_for('edit_project', project_id=project.id) }}" method="POST" class="d-inline-block ms-3">
            <input type="hidden" name="name" value="{{ project.name }}">
            <input type="hidden" name="description" value="{{ project.description }}">
            <select name="status" class="form-select form-select-sm d-inline-block w-auto" onchange="this.form.submit()">
                <option value="Active" {% if project.status == 'Active' %}selected{% endif %}>Active</option>
                <option value="Completed" {% if project.status == 'Completed' %}selected{% endif %}>Completed</option>
                <option value="Archived" {% if project.status == 'Archived' %}selected{% endif %}>Archived</option>
            </select>
        </form>
        {% endif %}
    </div>

    <div class="col-md-6 mb-3">
        <h4 class="mb-3">Project Members</h4>
        <ul class="list-group">
            {% for member in project_members %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>
                    {{ member.username }} 
                    {% if project.user_id == member.id %}<span class="badge bg-dark ms-2">Owner</span>{% endif %}
                </span>
                {% if is_owner and project.user_id != member.id %}
                <form action="{{ url_for('remove_project_member', project_id=project.id, user_id=member.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to remove this user?');">
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-user-minus"></i> Remove
                    </button>
                </form>
                {% endif %}
            </li>
            {% endfor %}
        </ul>

        {% if is_owner and other_users %}
        <form action="{{ url_for('add_project_member', project_id=project.id) }}" method="POST" class="mt-3">
            <label for="user_id" class="form-label">Add a Member</label>
            <div class="input-group">
                <select class="form-select" id="user_id" name="user_id" required>
                    {% for user in other_users %}
                    <option value="{{ user.id }}">{{ user.username }} ({{ user.email }})</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i> Add
                </button>
            </div>
        </form>
        {% endif %}
    </div>
</div>

<hr>

<!-- Task Management Section -->
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h3 class="mb-0">Tasks</h3>
        <a href="{{ url_for('add_task', project_id=project.id) }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add New Task
        </a>
    </div>
</div>

<div class="row kanban-board">
    <div class="col-md-4 mb-3">
        <div class="kanban-column">
            <div class="kanban-column-header">To Do</div>
            {% for task in tasks_todo %}
            <div class="card task-card" data-status="To Do">
                <div class="card-body">
                    <h6 class="card-title">{{ task.title }}</h6>
                    <p class="card-text text-muted">{{ task.description }}</p>
                    <small class="d-block text-end">Due: {{ task.due_date.strftime('%d/%m/%Y') if task.due_date else 'N/A' }}</small>
                    <small class="d-block text-end">Assigned To: {{ task.assignee.username }}</small>
                    <div class="d-flex justify-content-between mt-2">
                        <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn btn-outline-primary btn-sm"><i class="fas fa-edit"></i> Edit</a>
                        <form action="{{ url_for('delete_task', task_id=task.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this task?');">
                            <button type="submit" class="btn btn-outline-danger btn-sm"><i class="fas fa-trash-alt"></i> Delete</button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="kanban-column">
            <div class="kanban-column-header">In Progress</div>
            {% for task in tasks_in_progress %}
            <div class="card task-card" data-status="In Progress">
                <div class="card-body">
                    <h6 class="card-title">{{ task.title }}</h6>
                    <p class="card-text text-muted">{{ task.description }}</p>
                    <small class="d-block text-end">Due: {{ task.due_date.strftime('%d/%m/%Y') if task.due_date else 'N/A' }}</small>
                    <small class="d-block text-end">Assigned To: {{ task.assignee.username }}</small>
                    <div class="d-flex justify-content-between mt-2">
                        <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn btn-outline-primary btn-sm"><i class="fas fa-edit"></i> Edit</a>
                        <form action="{{ url_for('delete_task', task_id=task.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this task?');">
                            <button type="submit" class="btn btn-outline-danger btn-sm"><i class="fas fa-trash-alt"></i> Delete</button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="kanban-column">
            <div class="kanban-column-header">Done</div>
            {% for task in tasks_done %}
            <div class="card task-card" data-status="Done">
                <div class="card-body">
                    <h6 class="card-title">{{ task.title }}</h6>
                    <p class="card-text text-muted">{{ task.description }}</p>
                    <small class="d-block text-end">Due: {{ task.due_date.strftime('%d/%m/%Y') if task.due_date else 'N/A' }}</small>
                    <small class="d-block text-end">Assigned To: {{ task.assignee.username }}</small>
                    <div class="d-flex justify-content-between mt-2">
                        <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn btn-outline-primary btn-sm"><i class="fas fa-edit"></i> Edit</a>
                        <form action="{{ url_for('delete_task', task_id=task.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this task?');">
                            <button type="submit" class="btn btn-outline-danger btn-sm"><i class="fas fa-trash-alt"></i> Delete</button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
